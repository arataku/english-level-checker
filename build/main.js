(()=>{var M=class{constructor(e){this.text=e}startTime=null;wordCount=0;timeout=[];set content(e){this.text.textContent=e}start(){this.startTime=new Date().getTime();let e=window.setTimeout(()=>{this.content="Scanning...",this.timeout=this.timeout.filter(n=>n!==e)},300);this.timeout.push(e)}finishScan(e){let n=window.setTimeout(()=>{this.wordCount=e,this.content=`0/${this.wordCount} Words...`,this.timeout=this.timeout.filter(r=>r!==n)},300);this.timeout.push(n)}processedWordCountRefresh(e){this.startTime!==null&&(new Date().getTime()-this.startTime<300||(this.content=`${e}/${this.wordCount} Words...`))}finish(e){this.timeout=this.timeout.filter(n=>(clearInterval(n),!1)),this.startTime!==null?this.content=`Ready! ${e} Words (${new Date().getTime()-this.startTime}ms)`:this.content=`Ready! ${e} Words`}};var _={RED:"red",ORANGE:"orange",BLACK:"black"};var C=class{_textElement;_levelElement;_displayDivElement;_processor;constructor(){}textElement(e){if(!(e instanceof HTMLTextAreaElement))throw"inputElement must be an instance of HTMLTextAreaElement.";return this._textElement=e,this}levelElement(e){if(!(e instanceof HTMLInputElement))throw"levelElement must be an instance of HTMLInputElement.";return this._levelElement=e,this}displayDivElement(e){if(!(e instanceof HTMLDivElement))throw"displayDivElement must be an instance of HTMLDivElement.";return this._displayDivElement=e,this}processor(e){return this._processor=e,this}render(){if(this._textElement===void 0||this._levelElement===void 0||this._displayDivElement===void 0||this._processor===void 0)throw"render must be executed after inputElement, displayDivElement, and processor.";new l(this._textElement,this._levelElement,this._displayDivElement,this._processor)}},k=()=>new Promise(c=>setTimeout(c,0)),l=class{constructor(e,n,r,h){this.textElement=e;this.levelElement=n;this.displayDivElement=r;this.processor=h;let T=document.createElement("p");this.statusText=new M(T),this.tokenViewer=document.createElement("div"),this.startElement=document.createElement("span"),this.tokenViewer.appendChild(this.startElement),r.appendChild(T),r.appendChild(this.tokenViewer);let d=async g=>{if(this.rendering){console.warn("It is skipped because render during render.");return}this.rendering=!0,this.statusText.start(),this.statusText.finishScan(this.tokens.length);let v=[];for(let s=0;s<this.tokens.length;s++){let f=this.tokens[s],p=h({text:f.text},g);(p.color!==f.color||p.refreshedText!==f.refreshedText)&&v.push({index:s,newToken:p}),s%20===0&&(this.statusText.processedWordCountRefresh(s),await k())}this.statusText.processedWordCountRefresh(this.tokens.length),await k();let m=[];this.tokens=this.tokens.map((s,f)=>{let p=v.find(t=>t.index===f)?.newToken;if(p===void 0)return s;let E=f===0?this.startElement:this.tokens[f-1].elements[this.tokens[f-1].elements.length-1],S=s.text===`
`?[l.colorSpan("","black",!0)]:[l.colorSpan(s.beforeText,"black"),l.colorSpan(p.refreshedText??s.text,p.color),l.colorSpan(s.afterText+" ","black")];m.push(...s.elements);let L=document.createDocumentFragment();return S.forEach(t=>L.appendChild(t)),E.parentNode?.insertBefore(L,E.nextSibling),{beforeText:s.beforeText,text:s.text,afterText:s.afterText,...p,elements:S}}),m.forEach(s=>s.remove()),this.statusText.finish(this.tokens.length),await k();let o=Math.floor(Number(this.levelElement.value));if(g!==o){this.rendering=!1,console.log(`Playback: ${o}`),d(o);return}this.rendering=!1},b=async()=>{if(this.rendering){console.warn("It is skipped because render during render.");return}this.rendering=!0,this.statusText.start();let g=this.textElement.value,v=g===""?[]:(g.endsWith(" ")?g.slice(0,-1):g).split(/\n/).map(t=>t.split(" ")).flatMap(t=>[...t,`
`]);await k();let m=v.map(l.splitText),o=0,s=0;for(let t=0;t<Math.min(m.length,this.tokens.length);t++){let i=m[t],x=this.tokens[t];if(i.text===x.text&&i.beforeText===x.beforeText&&i.afterText===x.afterText)o++;else break}await k();for(let t=0;t<Math.min(m.length,this.tokens.length);t++){let i=m[m.length-t-1],x=this.tokens[this.tokens.length-t-1];if(i.text===x.text&&i.beforeText===x.beforeText&&i.afterText===x.afterText)s++;else break}await k();let f=o===0?this.startElement:this.tokens[o-1].elements[this.tokens[o-1].elements.length-1],p=document.createDocumentFragment(),E=[];this.statusText.finishScan(m.length-s-1-o);let S=Math.floor(Number(this.levelElement.value));for(let t=o;t<=m.length-s-1;t++){let i=m[t],x=h({text:i.text},S),I=i.text===`
`?[l.colorSpan("","black",!0)]:[l.colorSpan(i.beforeText,"black"),l.colorSpan(x.refreshedText??i.text,x.color),l.colorSpan(i.afterText+" ","black")];E.push({...i,...x,elements:I}),I.forEach(B=>p.appendChild(B)),(t-o+1)%20===0&&(this.statusText.processedWordCountRefresh(t-o+1),await k())}f.parentNode?.insertBefore(p,f.nextSibling);let L=this.tokens.filter((t,i)=>o<=i&&i<=this.tokens.length-s-1).flatMap(t=>t.elements);console.log(L),L.forEach(t=>t.remove()),this.tokens.length===0?this.tokens=E:this.tokens=this.tokens.flatMap((t,i)=>i===0&&o===0?E:i===o-1?[t,...E]:o<=i&&i<=this.tokens.length-s-1?[]:[t]),this.statusText.finish(this.tokens.length),this.rendering=!1};this.textElement.addEventListener("input",()=>b());let u=()=>{let g=Math.floor(Number(this.levelElement.value)),v=document.getElementById("range_value");v.textContent=g.toString(),d(g)};this.levelElement.addEventListener("input",()=>u()),this.levelElement.addEventListener("change",()=>u())}tokenViewer;statusText;startElement;tokens=[];rendering=!1;static splitText(e){let n=e.match(/^([^a-zA-Z-\']*)([a-zA-Z-\']+)([^a-zA-Z-\']*)$/);return n===null?{beforeText:"",text:e,afterText:""}:{beforeText:n[1],text:n[2],afterText:n[3]}}static colorSpan(e,n,r=!1){let h=document.createElement("span");return h.textContent=e,h.classList.add(n),r&&h.classList.add("linebreak"),h}};var H=class{cache={english:[],japanese:[],idx:[]};dict=void 0;constructor(){}readtxt(e,n,r){this.cacheClear();let h={english:[[],[],[],[]],japanese:[]};for(let T of e.split(`
`)){let d=T.split("	");if(d.length<n||d.length<r)break;h.english.map((b,u)=>b.push(d[n].toLowerCase().slice(0,d[n].length-u))),h.japanese.push(d[r])}this.dict=h}searchWord(e,n){let r=this.cache.english.indexOf(e);if(r!==-1&&this.cache.japanese[r])return n<=this.cache.idx[r]?this.cache.japanese[r]:void 0;if(this.dict===void 0)return;let h=this.dict;for(let T=0;T<4;T++)for(let d=0;d<4;d++){let b=e.slice(0,e.length-d).toLowerCase(),u=this.dict.english[T].indexOf(b);if(u!==-1)return this.cache.english.includes(e)||this.addCache(e,this.dict.japanese[u],u),u>=n&&this.dict.japanese[u]?this.dict.japanese[u]:void 0}}addCache(e,n,r){this.cache.english.push(e),this.cache.japanese.push(n),this.cache.idx.push(r),this.cache.english.length>3e3&&(this.cache.english.shift(),this.cache.japanese.shift(),this.cache.idx.shift())}cacheClear(){this.cache={english:[],japanese:[],idx:[]}}};new C().textElement(document.getElementById("input")).levelElement(document.getElementById("level")).displayDivElement(document.getElementById("resultdisplay_main")).processor((c,e)=>{if(a.dict===void 0)return{color:_.BLACK};let n=a.searchWord(c.text,e);return n!==void 0?{color:_.RED,refreshedText:`${c.text}(${n})`}:{color:_.BLACK}}).render();var a=new H,j=document.getElementById("anki_txt"),A=document.getElementById("anki_txt_refresh"),w=document.getElementById("level"),D=document.getElementById("anki_setting_english_col"),N=document.getElementById("anki_setting_japanese_col");localStorage.anki_txt_dict!==void 0&&(a.dict=JSON.parse(localStorage.anki_txt_dict),a.dict&&(w.max=a.dict.japanese.length.toString()));var y=document.getElementById("import_anki_txt_file");y.addEventListener("change",()=>{let c=new FileReader;c.onload=()=>{!c.result||(a.readtxt(c.result?.toString(),Number(D.value),Number(N.value)),localStorage.anki_txt_dict=JSON.stringify(a.dict),a?.dict?w.max=a.dict.japanese.length.toString():w.max="1")},y.files&&c.readAsText(y.files[0],"UTF-8")});A?.addEventListener("click",()=>{if(a.dict===void 0||window.confirm("\u3059\u3067\u306B\u4FDD\u5B58\u3055\u308C\u305F\u30C7\u30FC\u30BF\u304C\u3042\u308A\u307E\u3059\u3002\r\u4E0A\u66F8\u304D\u3057\u3066\u66F4\u65B0\u3057\u307E\u3059\u304B\uFF1F")){if(!(j instanceof HTMLTextAreaElement))throw"#anki_txt does not exist or is not an instance of HTMLInputElement!";a.readtxt(j.value,2,4),a?.dict?w.max=a.dict.japanese.length.toString():w.max="1",localStorage.anki_txt_dict=JSON.stringify(a.dict),alert("\u30C7\u30FC\u30BF\u3092\u66F4\u65B0\u3057\u307E\u3057\u305F\u3002")}});})();
//# sourceMappingURL=main.js.map
